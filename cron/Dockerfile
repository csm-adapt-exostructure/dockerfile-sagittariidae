# -*- docker-image-name: "sagittariidae" -*-

FROM csm-adapt/sagittariidae-base:0.0.0
MAINTAINER Docker <docker@adapt.mines.edu>

# Runtime environment setup. It requires `root` privileges so it is done before
# setting up the user as which the application will run.

# Application requirements
RUN apk --progress add \
    python=2.7.12-r0 \
    py-pip=8.1.2-r0

# Assume the `run as` user identity.
USER ${SVCUSER}
ENV WS=${HOME}/sagittariidae-ws.git
WORKDIR ${HOME}

# Fetch application artefacts.
RUN git clone \
    https://github.com/sinistral/csm-adapt.sagittariidae.git \
    ${WS} \
    && cd ${WS} \
    && git checkout -b ${WSVER} ${WSVER} \
    && cd -

# TODO: Run as application hook.
WORKDIR ${WS}
RUN pip install \
    --user \
    --requirement requirements.txt

RUN chmod u+x ${WS}/cron/sweep && crontab cron/crontab

USER root
ENV LOCKDIR=/var/lock/sagittariidae
ENV LOCKFILE=${LOCKDIR}/cron.lock
RUN mkdir -p ${LOCKDIR} && touch ${LOCKFILE} && chown adapt-sagittariidae ${LOCKFILE}

CMD ["crond", "-f", "-L", "/var/log/crond", "-l", "4"]
